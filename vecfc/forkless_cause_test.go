package vecfc

import (
	"fmt"
	"math/rand"
	"strconv"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/Fantom-foundation/lachesis-base/hash"
	"github.com/Fantom-foundation/lachesis-base/inter/dag"
	"github.com/Fantom-foundation/lachesis-base/inter/dag/tdag"
	"github.com/Fantom-foundation/lachesis-base/inter/idx"
	"github.com/Fantom-foundation/lachesis-base/inter/pos"
	"github.com/Fantom-foundation/lachesis-base/kvdb"
	"github.com/Fantom-foundation/lachesis-base/kvdb/flushable"
	"github.com/Fantom-foundation/lachesis-base/kvdb/memorydb"
	"github.com/Fantom-foundation/lachesis-base/vecengine/vecflushable"
)

func tCrit(err error) { panic(err) }

func BenchmarkIndex_ForklessCause(b *testing.B) {
	for i := 0; i < b.N; i++ {
		b.StopTimer()
		benchForklessCauseMain(b, &i, true)
	}
}

func BenchmarkIndex_ForklessCause_LevelDB(b *testing.B) {
	for i := 0; i < b.N; i++ {
		b.StopTimer()
		benchForklessCauseMain(b, &i, false)
	}
}

func benchForklessCauseMain(b *testing.B, idx *int, inmem bool) {
	benchForklessCauseProcess(b, idx, inmem)
}

func benchForklessCauseProcess(b *testing.B, idx *int, inmem bool) {
	nodes := tdag.GenNodes(10)
	validators := pos.EqualWeightValidators(nodes, 1)

	events := make(map[hash.Event]dag.Event)
	getEvent := func(id hash.Event) dag.Event {
		return events[id]
	}

	var db kvdb.Store
	if inmem {
		db = memorydb.New()
	} else {
		db, _ = tempLevelDB()
		defer func() {
			err := db.Close()
			if err != nil {
				panic(err)
			}
			db.Drop()
		}()
	}

	vi := NewIndex(tCrit, LiteConfig())
	vi.Reset(validators, vecflushable.Wrap(db, vecflushable.TestSizeLimit), getEvent)

	tdag.ForEachRandEvent(nodes, 10, 2, nil, tdag.ForEachEvent{
		Process: func(e dag.Event, name string) {
			events[e.ID()] = e
			err := vi.Add(e)
			if err != nil {
				panic(err)
			}
			vi.Flush()
		},
	})

	// check
	b.StartTimer()
	for _, ev := range events {
		for _, by := range events {
			who := by.ID()
			whom := ev.ID()
			vi.ForklessCause(who, whom)
			if *idx > b.N {
				b.StopTimer()
				return
			}
			*idx++
		}
	}
	b.StopTimer()
}

func TestForklessCausedClassic(t *testing.T) {

	t.Run("step 3", func(t *testing.T) {
		testForklessCaused(t, `
a0_1(3)  b0_1     c0_1
║        ║        ║
╠─────── b1_2     ║
║        ║        ║
║        ╠─────── c1_3
║        ║        ║
`)
	})

	t.Run("step 4", func(t *testing.T) {
		testForklessCaused(t, `
a0_1(3)  b0_1     c0_1
║        ║        ║
╠─────── b1_2     ║
║        ║        ║
║        ╠─────── c1_3
║        ║        ║
║        b2_4 ────╣
║        ║        ║
`)
	})

	t.Run("step 5", func(t *testing.T) {
		testForklessCaused(t, `
a0_1(3)  b0_1(5)  c0_1(5)
║        ║        ║
╠─────── b1_2(5)  ║
║        ║        ║
║        ╠─────── c1_3(5)
║        ║        ║
║        b2_4 ────╣
║        ║        ║
a1_5 ────╣        ║
║        ║        ║
`)
	})

}

// testForklessCaused uses event name agreement:
//  "<name>_<level>[(by-level)]",
// where by-level means that event is forkless seen by all event with level >= by-level.
func testForklessCaused(t *testing.T, dagAscii string) {
	assertar := assert.New(t)

	nodes, _, _ := tdag.ASCIIschemeToDAG(dagAscii)
	validators := pos.EqualWeightValidators(nodes, 1)

	events := make(map[hash.Event]dag.Event)
	getEvent := func(id hash.Event) dag.Event {
		return events[id]
	}

	vi := NewIndex(tCrit, LiteConfig())
	vi.Reset(validators, vecflushable.Wrap(memorydb.New(), vecflushable.TestSizeLimit), getEvent)

	_, _, named := tdag.ASCIIschemeForEach(dagAscii, tdag.ForEachEvent{
		Process: func(e dag.Event, name string) {
			events[e.ID()] = e
			err := vi.Add(e)
			if err != nil {
				panic(err)
			}
			vi.Flush()
		},
	})

	// check
	for dsc, ev := range named {
		_, bylevel := decode(dsc)
		for dsc, by := range named {
			level, _ := decode(dsc)

			who := by.ID()
			whom := ev.ID()
			if !assertar.Equal(
				bylevel > 0 && bylevel <= level,
				vi.ForklessCause(who, whom),
				fmt.Sprintf("%s forkless sees %s", who.String(), whom.String()),
			) {
				return
			}
		}
	}
}

func decode(dsc string) (level, bylevel int64) {
	var err error

	s := strings.Split(dsc, "_")
	s = strings.Split(s[1], "(")

	level, err = strconv.ParseInt(s[0], 10, 32)
	if err != nil {
		panic(err)
	}

	if len(s) < 2 {
		return
	}

	bylevel, err = strconv.ParseInt(strings.TrimRight(s[1], ")"), 10, 32)
	if err != nil {
		panic(err)
	}

	return
}

func TestForklessCausedRandom(t *testing.T) {
	t.Run("memorydb", func(t *testing.T) {
		dbProducer := func() kvdb.FlushableKVStore {
			return flushable.Wrap(memorydb.New())
		}
		testForklessCausedRandom(t, dbProducer)
	})
	t.Run("leveldb", func(t *testing.T) {
		dbProducer := func() kvdb.FlushableKVStore {
			db, _ := tempLevelDB()
			return flushable.Wrap(db)
		}
		testForklessCausedRandom(t, dbProducer)
	})
	t.Run("vecflushable", func(t *testing.T) {
		// by setting a small sizeLimit we force the db to switch to a persitent
		// underlying db
		dbProducer := func() kvdb.FlushableKVStore {
			db, _ := tempLevelDB()
			return vecflushable.Wrap(db, vecflushable.TestSizeLimit)
		}
		testForklessCausedRandom(t, dbProducer)
	})
}

func testForklessCausedRandom(t *testing.T, dbProducer func() kvdb.FlushableKVStore) {
	assertar := assert.New(t)

	// generated by codegen4ForklessCausedStability()
	dagAscii := `
 a000    
 ║        ║       
 ╠═══════ b000    
 ║        ║        ║       
 ║        ║        c000    
 ║        ║        ║        ║       
 ╠═══════─╫─══════─╫─══════ d000    
 ║        ║        ║        ║       
 a001════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════ b001     ║        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c001     ║       
 ║        ║        ║        ║       
 ║        b002═════╣        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d001    
 ║        ║        ║        ║       
 a002════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a003═════╣        ║        ║       
 ║        ║        ║        ║       
 ╠═══════ b003     ║        ║       
 ║        ║        ║        ║       
 ║        ║        c002═════╣       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d002    
 ║        ║        ║        ║       
 ║        ║        c003═════╣       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d003    
 ║        ║        ║        ║       
 a004════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════ b004     ║        ║       
 ║        ║        ║        ║       
 ║        ║        c004═════╣       
 ║        ║        ║        ║       
 a005════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b005     ║        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c005     ║       
 ║        ║        ║        ║       
 a006════─╫─═══════╣        ║       
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d004    
 ║        ║        ║        ║       
 ║        ╠═══════─╫─══════ d005    
 ║        ║        ║        ║       
 ║        b006════─╫─═══════╣       
 ║        ║        ║        ║       
 a007═════╣        ║        ║       
 ║        ║        ║        ║       
 ║        ║        c006═════╣       
 ║        ║        ║        ║       
 ║        ╠═══════─╫─══════ d006    
 ║        ║        ║        ║       
 ║        b007════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        ║        c007═════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════─╫─══════ d007    
 ║        ║        ║        ║       
 a008════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        b008════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        ╠═══════ c008     ║       
 ║        ║        ║        ║       
 a009════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b009     ║        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d008    
 ║        ║        ║        ║       
 ║        ║        c009═════╣       
 ║        ║        ║        ║       
 ║        b010═════╣        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d009    
 ║        ║        ║        ║       
 a010════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c010     ║       
 ║        ║        ║        ║       
 ║        b011═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c011     ║       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d010    
 ║        ║        ║        ║       
 a011════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a012════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b012     ║        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c012     ║       
 ║        ║        ║        ║       
 ║        b013═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c013     ║       
 ║        ║3       ║        ║       
 ║        ║╚══════─╫─══════ d011    
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d012    
 ║        ║        ║        ║       
 a013════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a014═════╣        ║        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c014     ║       
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d013    
 ║        ║        ║        ║       
 ║        b014════─╫─═══════╣       
 ║        ║        ║        ║       
 a015═════╣        ║        ║       
 ║        ║        ║        ║       
 ║        b015═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c015     ║       
 ║        ║        ║        ║       
 a016════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ║        b016═════╣        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c016     ║       
 ║        ║        ║        ║       
 a017════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ║        b017═════╣        ║       
 ║        ║        ║        ║       
 a018═════╣        ║        ║       
 ║5       ║        ║        ║       
 ║╚══════─╫─══════─╫─══════ d014    
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d015    
 ║3       ║        ║        ║       
 ║╚══════─╫─══════─╫─══════ d016    
 ║        ║        ║        ║       
 ║        ║        c017═════╣       
 ║        ║        ║        ║       
 ║        b018═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c018     ║       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d017    
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d018    
 ║        ║        ║        ║       
 a019════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        b019════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c019     ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d019    
`
	relations := map[string]map[string]struct{}{
		"a000": map[string]struct{}{},
		"a001": map[string]struct{}{},
		"a002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"a003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"a004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}},
		"a005": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"a006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"a007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"a008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"a009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"a010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"a011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"a012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"a013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"a014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"a015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"b000": map[string]struct{}{},
		"b001": map[string]struct{}{"a000": {}, "d000": {}},
		"b002": map[string]struct{}{"a000": {}, "a001": {}, "d000": {}},
		"b003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}, "d001": {}},
		"b004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b005": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"b009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"b010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"b011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"b012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}},
		"b016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"b017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"b018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"b019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"c000": map[string]struct{}{},
		"c001": map[string]struct{}{"a000": {}, "a001": {}, "d000": {}},
		"c002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "d000": {}},
		"c003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"c004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"c005": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"c006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"c007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"c008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"c009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"c010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"c011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"c012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"c013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"c014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}},
		"c015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"c019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}, "d017": {}, "d018": {}},
		"d000": map[string]struct{}{},
		"d001": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "d000": {}},
		"d002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"d003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"d004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"d005": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"d006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"d007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"d008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"d009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"d010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"d011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"d012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"d019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "a017": {}, "a018": {}, "a019": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}, "d017": {}, "d018": {}},
	}

	ordered := make(dag.Events, 0)
	nodes, _, named := tdag.ASCIIschemeForEach(dagAscii, tdag.ForEachEvent{
		Process: func(e dag.Event, name string) {
			ordered = append(ordered, e)
		},
	})

	validators := pos.EqualWeightValidators(nodes, 1)

	events := make(map[hash.Event]dag.Event)
	getEvent := func(id hash.Event) dag.Event {
		return events[id]
	}

	vi := NewIndex(tCrit, LiteConfig())
	vi.Reset(
		validators,
		dbProducer(),
		getEvent)

	// push
	for _, e := range ordered {
		events[e.ID()] = e
		err := vi.Add(e)
		if err != nil {
			panic(err)
		}
		vi.Flush()
	}

	// check
	for e1name, e1 := range named {
		for e2name, e2 := range named {
			_, expect := relations[e1name][e2name]
			if !assertar.Equal(
				expect,
				vi.ForklessCause(e1.ID(), e2.ID()),
				fmt.Sprintf("%s forkless sees %s", e1.ID(), e2.ID()),
			) {
				return
			}
		}
	}
}

type eventSlot struct {
	seq     idx.Event
	creator idx.ValidatorID
}

// naive implementation of fork detection, O(n)
func testForksDetected(vi *Index, head dag.Event) (cheaters map[idx.ValidatorID]bool, err error) {
	cheaters = map[idx.ValidatorID]bool{}
	visited := hash.EventsSet{}
	detected := map[eventSlot]int{}
	onWalk := func(id hash.Event) (godeeper bool) {
		// ensure visited once
		if visited.Contains(id) {
			return false
		}
		visited.Add(id)

		e := vi.getEvent(id)
		slot := eventSlot{
			seq:     e.Seq(),
			creator: e.Creator(),
		}
		detected[slot]++
		return true
	}
	onWalk(head.ID())
	err = vi.DfsSubgraph(head, onWalk)
	for s, count := range detected {
		if count > 1 {
			cheaters[s.creator] = true
		}
	}
	return cheaters, err
}

func TestRandomForksSanity(t *testing.T) {
	nodes := tdag.GenNodes(8)
	cheaters := []idx.ValidatorID{nodes[0], nodes[1], nodes[2]}

	validatorsBuilder := pos.NewBuilder()
	for _, peer := range nodes {
		validatorsBuilder.Set(peer, pos.Weight(1))
	}

	validatorsBuilder.Set(cheaters[0], pos.Weight(2))
	validatorsBuilder.Set(nodes[3], pos.Weight(2))
	validatorsBuilder.Set(nodes[4], pos.Weight(3))
	validators := validatorsBuilder.Build()

	processed := make(map[hash.Event]dag.Event)
	getEvent := func(id hash.Event) dag.Event {
		return processed[id]
	}

	vi := NewIndex(tCrit, LiteConfig())
	vi.Reset(validators, vecflushable.Wrap(memorydb.New(), vecflushable.TestSizeLimit), getEvent)

	// Many forks from each node in large graph, so probability of not seeing a fork is negligible
	events := tdag.ForEachRandFork(nodes, cheaters, 300, 4, 30, nil, tdag.ForEachEvent{
		Process: func(e dag.Event, name string) {
			if _, ok := processed[e.ID()]; ok {
				return
			}
			processed[e.ID()] = e
			err := vi.Add(e)
			if err != nil {
				panic(err)
			}
		},
	})

	vi.Flush()
	vi.DropNotFlushed() // doesn't drop anything, because everything is flushed

	// quick sanity check. all the nodes should see that cheaters have a fork, and honest nodes don't have forks
	assertar := assert.New(t)
	idxs := validatorsBuilder.Build().Idxs()
	for _, node := range nodes {
		ee := events[node]
		highestBefore := vi.GetMergedHighestBefore(ee[len(ee)-1].ID())
		for n, cheater := range nodes {
			branchSeq := highestBefore.Get(idxs[cheater])
			isCheater := n < len(cheaters)
			assertar.Equal(isCheater, branchSeq.IsForkDetected(), cheater)
			if isCheater {
				assertar.Equal(idx.Event(0), branchSeq.Seq, cheater)
			} else {
				assertar.NotEqual(idx.Event(0), branchSeq.Seq, cheater)
			}
		}
	}
}

func TestRandomForks(t *testing.T) {
	for i, test := range []struct {
		nodesNum      int
		cheatersNum   int
		eventsNum     int
		forksNum      int
		parentsNum    int
		reorderChecks int
	}{
		{
			nodesNum:      1,
			parentsNum:    1,
			cheatersNum:   1,
			eventsNum:     10,
			forksNum:      3,
			reorderChecks: 30,
		},
		{
			nodesNum:      2,
			parentsNum:    1,
			cheatersNum:   1,
			eventsNum:     10,
			forksNum:      3,
			reorderChecks: 20,
		},
		{
			nodesNum:      2,
			parentsNum:    2,
			cheatersNum:   2,
			eventsNum:     10,
			forksNum:      20,
			reorderChecks: 5,
		},
		{
			nodesNum:      10,
			parentsNum:    4,
			cheatersNum:   1,
			eventsNum:     10,
			forksNum:      3,
			reorderChecks: 5,
		},
		{
			nodesNum:      10,
			parentsNum:    4,
			cheatersNum:   10,
			eventsNum:     10,
			forksNum:      3,
			reorderChecks: 3,
		},
		{
			nodesNum:      20,
			parentsNum:    4,
			cheatersNum:   10,
			eventsNum:     5,
			forksNum:      2,
			reorderChecks: 3,
		},
		{
			nodesNum:      40,
			parentsNum:    4,
			cheatersNum:   10,
			eventsNum:     3,
			forksNum:      1,
			reorderChecks: 2,
		},
		{
			nodesNum:      5,
			parentsNum:    4,
			cheatersNum:   2,
			eventsNum:     30,
			forksNum:      30,
			reorderChecks: 2,
		},
	} {
		t.Run(fmt.Sprintf("Test #%d", i), func(t *testing.T) {
			r := rand.New(rand.NewSource(int64(i)))

			nodes := tdag.GenNodes(test.nodesNum)
			cheaters := nodes[:test.cheatersNum]

			validators := pos.EqualWeightValidators(nodes, 1)

			processedArr := dag.Events{}
			processed := make(map[hash.Event]dag.Event)
			getEvent := func(id hash.Event) dag.Event {
				return processed[id]
			}

			vi := NewIndex(tCrit, LiteConfig())
			vi.Reset(validators, vecflushable.Wrap(memorydb.New(), vecflushable.TestSizeLimit), getEvent)

			_ = tdag.ForEachRandFork(nodes, cheaters, test.eventsNum, test.parentsNum, test.forksNum, r, tdag.ForEachEvent{
				Process: func(e dag.Event, name string) {
					if _, ok := processed[e.ID()]; ok {
						return
					}
					processed[e.ID()] = e
					processedArr = append(processedArr, e)
					err := vi.Add(e)
					if err != nil {
						panic(err)
					}
				},
			})

			assertar := assert.New(t)
			idxs := validators.Idxs()
			// check that fork observing is identical to naive version
			for _, e := range processed {
				highestBefore := vi.GetHighestBefore(e.ID())
				expectedCheaters, err := testForksDetected(vi, e)
				assertar.NoError(err)

				for _, cheater := range nodes {
					expectedCheater := expectedCheaters[cheater]
					branchSeq := highestBefore.Get(idxs[cheater])
					assertar.Equal(expectedCheater, branchSeq.IsForkDetected(), e.String())
					if expectedCheater {
						assertar.Equal(idx.Event(0), branchSeq.Seq, e.String())
					}
				}
			}

			// memorize results of ForklessCause and MedianTime
			forklessCauseMap := map[kv]bool{}
			for _, a := range processedArr {
				for _, b := range processedArr {
					pair := kv{
						a: a.ID(),
						b: b.ID(),
					}
					forklessCauseMap[pair] = vi.ForklessCause(a.ID(), b.ID())
				}
			}

			vi.DropNotFlushed() // drops everything, because wasn't flushed
			for _, e := range processed {
				assertar.Nil(vi.GetHighestBefore(e.ID()))
				assertar.Nil(vi.GetLowestAfter(e.ID()))
			}

			// check that events re-order doesn't change forklessCause result
			for reorderTry := 0; reorderTry < test.reorderChecks; reorderTry++ {
				// re-order events randomly, preserving parents order
				unordered := make(dag.Events, len(processedArr))
				for i, j := range r.Perm(len(processedArr)) {
					unordered[i] = processedArr[j]
				}
				processedArr = tdag.ByParents(unordered)

				for _, a := range processedArr {
					assertar.NoError(vi.Add(a))
				}

				vi.cache.ForklessCause.Purge() // disable cache
				for _, a := range processedArr {
					for _, b := range processedArr {
						pair := kv{
							a: a.ID(),
							b: b.ID(),
						}
						res := vi.ForklessCause(a.ID(), b.ID())
						assertar.Equal(forklessCauseMap[pair], res, "%s %s %d", a.ID().String(), b.ID().String(), reorderTry)
					}
				}
				vi.DropNotFlushed()
			}
		})
	}
}

/*
// codegen4ForklessCausedStability is for test data generation.
func codegen4ForklessCausedStability() {
	peers := inter.GenNodes(4)
	events := inter.GenEventsByNode(peers, 20, 2, nil, nil, nil)

	validators := make(pos.Validators, len(peers))
	for _, peer := range peers {
		validators.Set(peer, pos.Weight(1))
	}
	vi := NewIndex(validators, memorydb.New())

	processed := make(map[hash.Event]*inter.Event)
	orderThenProcess := ordering.EventsBuffer(ordering.Callback{

		Process: func(e *inter.Event) {
			processed[e.ID()] = e
			vi.Add(e)
		},

		Drop: func(e *inter.Event, err error) {
			panic(err)
		},

		Exists: func(h hash.Event) *inter.Event {
			return processed[h]
		},
	})

	// push
	dag := inter.Events{}
	for _, ee := range events {
		for _, e := range ee {
			orderThenProcess(e)
		}
		dag = append(dag, ee...)
	}

	// generation
	scheme, err := inter.DAGtoASCIIscheme(dag)
	if err != nil {
		panic(err)
	}

	fmt.Printf("dag := `%s`\n", scheme)
	fmt.Printf("relations := map[string]map[string]struct{}{\n")
	for _, e1 := range dag {
		sees := fmt.Sprintf("\"%s\": map[string]struct{}{", e1.ID())
		for _, e2 := range dag {
			if vi.ForklessCause(e1.ID(), e2.ID()) {
				sees = sees + fmt.Sprintf("\"%s\":{},", e2.ID())
			}
		}
		sees += "},"
		fmt.Println(sees)
	}
	fmt.Printf("}\n")
}
*/
